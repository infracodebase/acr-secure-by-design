# Comprehensive Audit Logging and Monitoring Configuration
# Enterprise-grade observability for Zero Trust ACR and AKS

apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    name: monitoring
    purpose: observability
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted

---
# ConfigMap for Fluent Bit log forwarding
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: monitoring
  labels:
    app: fluent-bit
    component: log-forwarder
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020

    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        Parser            cri
        Tag               kube.*
        Refresh_Interval  5
        Mem_Buf_Limit     50MB
        Skip_Long_Lines   On

    [INPUT]
        Name systemd
        Tag  host.*
        Systemd_Filter _SYSTEMD_UNIT=kubelet.service

    [INPUT]
        Name systemd
        Tag  host.*
        Systemd_Filter _SYSTEMD_UNIT=docker.service

    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Keep_Log            Off
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off
        Annotations         Off
        Labels              On

    [FILTER]
        Name    modify
        Match   kube.*
        Add     cluster_name ${CLUSTER_NAME}
        Add     environment ${ENVIRONMENT}

    [FILTER]
        Name    grep
        Match   kube.*
        Exclude $kubernetes['container_name'] fluent-bit

    # Security events filter
    [FILTER]
        Name    grep
        Match   kube.*
        Regex   $log (denied|unauthorized|forbidden|failed|error|warning|authentication|authorization)

    [OUTPUT]
        Name                azure
        Match               *
        Customer_ID         ${WORKSPACE_ID}
        Shared_Key          ${WORKSPACE_KEY}
        Log_Type            ContainerLogs
        Time_Key            @timestamp
        Time_Generated      true

    [OUTPUT]
        Name                forward
        Match               security.*
        Host                siem-collector.security-system.svc.cluster.local
        Port                24224
        Require_ack_response true

  parsers.conf: |
    [PARSER]
        Name        cri
        Format      regex
        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name        json
        Format      json
        Time_Key    time
        Time_Format %d/%b/%Y:%H:%M:%S %z

---
# DaemonSet for Fluent Bit
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: monitoring
  labels:
    app: fluent-bit
    component: log-forwarder
spec:
  selector:
    matchLabels:
      app: fluent-bit
  template:
    metadata:
      labels:
        app: fluent-bit
        component: log-forwarder
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "2020"
        prometheus.io/path: "/api/v1/metrics/prometheus"
    spec:
      serviceAccountName: fluent-bit
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: fluent-bit
        image: fluent/fluent-bit:2.2.0
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 2020
          protocol: TCP
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        resources:
          limits:
            cpu: 200m
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 100Mi
        volumeMounts:
        - name: varlog
          mountPath: /var/log
          readOnly: true
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluent-bit-config
          mountPath: /fluent-bit/etc/
        - name: tmp
          mountPath: /tmp
        env:
        - name: CLUSTER_NAME
          value: "${CLUSTER_NAME}"
        - name: ENVIRONMENT
          value: "${ENVIRONMENT}"
        - name: WORKSPACE_ID
          valueFrom:
            secretKeyRef:
              name: log-analytics-secret
              key: workspace-id
        - name: WORKSPACE_KEY
          valueFrom:
            secretKeyRef:
              name: log-analytics-secret
              key: workspace-key
        livenessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/v1/health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluent-bit-config
        configMap:
          name: fluent-bit-config
      - name: tmp
        emptyDir:
          sizeLimit: 100Mi

---
# ServiceAccount for Fluent Bit
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluent-bit
  namespace: monitoring
  labels:
    app: fluent-bit
    component: log-forwarder
automountServiceAccountToken: true

---
# ClusterRole for Fluent Bit
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fluent-bit-read
  labels:
    app: fluent-bit
    component: log-forwarder
rules:
- apiGroups: [""]
  resources:
  - namespaces
  - pods
  - nodes
  verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding for Fluent Bit
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: fluent-bit-read
  labels:
    app: fluent-bit
    component: log-forwarder
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: fluent-bit-read
subjects:
- kind: ServiceAccount
  name: fluent-bit
  namespace: monitoring

---
# Secret for Log Analytics workspace credentials
apiVersion: v1
kind: Secret
metadata:
  name: log-analytics-secret
  namespace: monitoring
  labels:
    app: monitoring
    component: credentials
type: Opaque
data:
  workspace-id: "${BASE64_WORKSPACE_ID}"
  workspace-key: "${BASE64_WORKSPACE_KEY}"

---
# Service for Fluent Bit metrics
apiVersion: v1
kind: Service
metadata:
  name: fluent-bit
  namespace: monitoring
  labels:
    app: fluent-bit
    component: log-forwarder
spec:
  ports:
  - name: http
    port: 2020
    targetPort: http
    protocol: TCP
  selector:
    app: fluent-bit
    component: log-forwarder

---
# ConfigMap for Prometheus scraping configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
  labels:
    app: prometheus
    component: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - "/etc/prometheus/rules/*.yml"

    scrape_configs:
    # Kubernetes API Server
    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https

    # Kubernetes nodes
    - job_name: 'kubernetes-nodes'
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      kubernetes_sd_configs:
      - role: node
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)

    # Kubernetes pods
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name

    # ACR metrics (if exposed)
    - job_name: 'acr-metrics'
      static_configs:
      - targets: ['${ACR_LOGIN_SERVER}:443']
      scheme: https
      metrics_path: '/v2/_catalog'
      scrape_interval: 5m

  rules.yml: |
    groups:
    - name: acr_security_alerts
      rules:
      - alert: UnauthorizedACRAccess
        expr: increase(container_registry_unauthorized_access_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
          service: acr
        annotations:
          summary: "Unauthorized access attempt to ACR"
          description: "There have been {{ $value }} unauthorized access attempts to ACR in the last 5 minutes"

      - alert: ACRImagePullFailure
        expr: increase(container_registry_pull_errors_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
          service: acr
        annotations:
          summary: "High number of ACR pull failures"
          description: "{{ $value }} image pull failures from ACR in the last 5 minutes"

    - name: aks_security_alerts
      rules:
      - alert: PodSecurityViolation
        expr: increase(kyverno_policy_violation_total{policy_type="security"}[5m]) > 0
        for: 0m
        labels:
          severity: high
          service: aks
        annotations:
          summary: "Pod security policy violation detected"
          description: "Security policy violation: {{ $labels.policy_name }}"

      - alert: ImageSignatureVerificationFailure
        expr: increase(kyverno_image_verification_failure_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
          service: aks
        annotations:
          summary: "Image signature verification failed"
          description: "Image signature verification failed for {{ $labels.image }}"

---
# ServiceMonitor for Prometheus to scrape ACR and AKS metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: acr-aks-metrics
  namespace: monitoring
  labels:
    app: prometheus
    component: servicemonitor
spec:
  selector:
    matchLabels:
      app: fluent-bit
  endpoints:
  - port: http
    interval: 30s
    path: /api/v1/metrics/prometheus

---
# PrometheusRule for ACR and AKS security monitoring
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: acr-aks-security-rules
  namespace: monitoring
  labels:
    app: prometheus
    component: rules
spec:
  groups:
  - name: acr_security
    rules:
    - alert: ACRHighVulnerabilityFound
      expr: acr_vulnerability_critical_count > 0
      for: 0m
      labels:
        severity: critical
        service: acr
        category: security
      annotations:
        summary: "Critical vulnerability found in ACR image"
        description: "{{ $value }} critical vulnerabilities found in image {{ $labels.image_name }}"
        runbook_url: "https://wiki.company.com/runbooks/acr-vulnerability-response"

    - alert: ACRUnauthorizedPush
      expr: increase(acr_push_unauthorized_total[5m]) > 0
      for: 0m
      labels:
        severity: critical
        service: acr
        category: security
      annotations:
        summary: "Unauthorized push attempt to ACR"
        description: "Unauthorized push attempt from {{ $labels.source_ip }} to repository {{ $labels.repository }}"

  - name: aks_security
    rules:
    - alert: UnsignedImageDeployed
      expr: increase(aks_unsigned_image_deployed_total[1m]) > 0
      for: 0m
      labels:
        severity: critical
        service: aks
        category: security
      annotations:
        summary: "Unsigned image deployed to AKS"
        description: "Unsigned image {{ $labels.image }} deployed to namespace {{ $labels.namespace }}"

    - alert: PrivilegedPodCreated
      expr: increase(aks_privileged_pod_created_total[1m]) > 0
      for: 0m
      labels:
        severity: high
        service: aks
        category: security
      annotations:
        summary: "Privileged pod created in AKS"
        description: "Privileged pod {{ $labels.pod_name }} created in namespace {{ $labels.namespace }}"